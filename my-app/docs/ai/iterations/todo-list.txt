## High-confidence bugs (will break builds or behave wrong)

### 2) â€œUndoâ€ actions are async but invoked like sync (silent failure + race bugs)

You pass async functions as toast actions (example: undo delete) , but the Toast â€œUndoâ€ click calls the action without awaiting it and immediately clears the toast .

**Why this matters:**

* If undo throws/rejects, youâ€™ll likely get an unhandled promise rejection (or nothing visible at all).
* Clearing the toast immediately makes it harder to show â€œUndo failedâ€ feedback.
* If the user taps Undo rapidly or navigates away, state can desync.

âœ… **Fix direction:** make `Toast` support `async` actions (await, show loading/disable button, catch errors, optionally keep toast until completion).

---

### 3) Stale-state risks in async handlers (can resurrect deleted items or lose edits)

Example: `handleDeleteSet` reads `sessionSets[setEntry.date]` after an `await deleteSet(...)` . If anything else updates `sessionSets` while the delete request is in flight, you may compute the â€œnext listâ€ from an old snapshot.

âœ… **Fix direction:** for state derived from previous state, compute inside a functional setter (or centralize list updates in one reducer/store).

---

## Bad practices that will keep generating bugs

### 4) â€œMonolith page componentsâ€ doing everything

Pages contain UI rendering + gesture logic + data fetching + optimistic updates + undo logic. Thatâ€™s a bug factory because changes in one corner ripple everywhere.

âœ… **Fix direction:** split into:

* **data layer** (hooks/services)
* **state/update layer** (reducer or store)
* **UI components** (pure rendering)

---

### 5) Duplicate logic across pages (drift + inconsistent behavior)

Toast logic, edit/delete patterns, formatting, etc. appear in multiple places (Log + History especially). When you fix a bug in one page, the twin bug survives elsewhere.

âœ… **Fix direction:** extract shared helpers:

* `useToast()` hook (with async action support)
* `useOptimisticSetMutations()` or a small â€œsets controllerâ€
* common `formatTotal`, `formatSetLabel` utilities

---

### 6) Error handling is mostly `console.error`

You do log errors in effects, but most async handlers donâ€™t surface failures to the user (delete/update/add). Thatâ€™s how â€œmy set disappearedâ€ becomes a mystery novel.

âœ… **Fix direction:** show user-facing error toasts + retry when mutations fail.

---

## TODO list of fixes (practical order)

### ğŸ”¥ P0: Make it build + stop the worst runtime failures

* [ ] Standardize imports across all pages (prefer `@/â€¦` aliases). Fix `app/settings/page.tsx` bad path `././components/AppShell`  and remove `./components/...` usage in `app/page.tsx` .
* [ ] Fix Toast action handling to support async:

  * [ ] `onAction` should `await toast.action?.()` and catch errors 
  * [ ] disable Undo while running; show â€œUndo failedâ€ if needed.
* [ ] Audit all places passing async undo actions (ex: delete undo)  and ensure they behave correctly.

### âš™ï¸ P1: Correctness + consistency

* [ ] Remove stale-state patterns in async handlers:

  * [ ] Rewrite list updates to use functional state updates (or a reducer) instead of reading state after `await` .
* [ ] Add user-facing error feedback for failed mutations (add/update/delete session/set).
* [ ] Add â€œoptimistic update rollbackâ€ patterns that are consistent (one utility, not per-page improvisation).

### ğŸ§¼ P2: Refactor for maintainability

* [ ] Extract a shared `useToast()` hook (timer, queueing, async action support) used by Log/History/Progress.
* [ ] Extract â€œset mutations controllerâ€:

  * `deleteSetWithUndo(setEntry)`
  * `updateSetWithUndo(prev,next)`
  * `addSetOptimistic(...)`
* [ ] Split giant pages: container component (data + handlers) vs presentational components.

### ğŸ§ª P3: Safety net (tests + tooling)

* [ ] Add ESLint rules for:

  * import path consistency
  * exhaustive-deps (with intentional escapes documented)
* [ ] Add basic unit tests for:

  * `buildSessionSummary` ordering + volume math
  * undo flows (delete -> undo -> restored)
* [ ] Add an integration smoke test: â€œlog a set, delete it, undo it, verify itâ€™s backâ€.
