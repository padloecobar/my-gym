Next.js-specific Refactor TODOs — my-gym
Created: 2026-01-25

Purpose: Focused, actionable Next.js / App Router items to modernize structure, server/client boundaries, and platform integration.

1) Enforce Server / Client Boundaries
- Description: Audit files for unnecessary `"use client"` directives. Convert components and pages that do not require browser APIs into server components. Move data fetching into server components or route handlers.
- Targets: `my-app/app/page.tsx`, `my-app/app/history/page.tsx`, `my-app/components/*`
- Effort: small-med | Risk: low-medium

2) Use Server Actions for Mutations
- Description: Replace client-side direct DB calls with Next.js Server Actions where appropriate (for authenticated or sensitive mutations). Provide a thin server API that calls `lib/db` and returns typed results.
- Targets: pages with direct writes (log page, settings handlers)
- Effort: medium | Risk: medium

3) Move IO/Secrets to API Route Handlers
- Description: Introduce `app/api/*/route.ts` handlers for any external or server-only operations (LLM proxy, file processing, backup import/export). Ensure API routes read `process.env` and never leak secrets to the client bundle.
- Targets: new `my-app/app/api/llm/route.ts`, `my-app/app/api/backup/route.ts`
- Effort: small | Risk: low

4) Centralize Environment & Next Config
- Description: Ensure secrets are only referenced in server code; add clear docs for required env variables. Review `next.config.ts` for experimental flags; explicitly document any experimental features in `docs/`.
- Targets: `my-app/next.config.ts`, `my-app/docs/ai/` files
- Effort: small | Risk: low

5) Layout / Providers in Server Components
- Description: Make `app/layout.tsx` a server component where possible and move only client-side providers (toasts, SW registration, file pickers) into small client wrapper components. Reduce bundling of client code across the app.
- Targets: `my-app/app/layout.tsx`, `my-app/components/PwaRegister.tsx`, `my-app/components/ToastProvider.tsx`
- Effort: small | Risk: low

6) Streaming / Suspense for Large Data Views
- Description: Use React Suspense + streaming server-rendering for heavy pages (history/progress). Serve partial UI while data is fetched; move aggregation logic to server to reduce client work.
- Targets: `my-app/app/history/page.tsx`, `my-app/app/progress/page.tsx`
- Effort: medium | Risk: medium

7) Adopt Route Handlers for LLM & Heavy Compute
- Description: Implement route handlers that can stream responses (ReadableStream) and support server-side streaming to the client. Keep long-running tasks off the client.
- Targets: `my-app/app/api/llm/route.ts`, `my-app/lib/llm.ts` (new)
- Effort: medium | Risk: medium-high

8) Integrate Caching Strategies (fetch & ISR)
- Description: Where appropriate, leverage Next's `fetch` caching, `revalidate`, or ISR for non-personalized data (e.g., exercise catalog). Avoid doing full re-compute on each request.
- Targets: server components that call external services or run heavy aggregations
- Effort: small | Risk: low

9) Service Worker & PWA Integration (Next-aware)
- Description: Keep `public/sw.js` as the worker but centralize registration in a client component/hook that is loaded only on the client. Ensure SW caching strategy complements Next's asset caching; document how SW interacts with Next static assets and next-on-netlify/adapter specifics if used.
- Targets: `public/sw.js`, `my-app/components/PwaRegister.tsx`, `my-app/lib/pwa.ts` (new)
- Effort: small | Risk: medium

10) Edge & Middleware for Security / Rate-limiting
- Description: Use Next Middleware or Edge functions for low-latency checks (rate-limiting, bot protection) before reaching API handlers. Prefer Node route handlers for LLM proxying but gate via middleware when needed.
- Targets: `middleware.ts` (new), `app/api/llm/route.ts`
- Effort: medium | Risk: medium

11) Improve Import Paths and TS Aliases
- Description: Add clear `paths` in `tsconfig.json` (e.g., `@/hooks/*`, `@/lib/*`, `@/components/*`) and keep imports consistent to improve DX and simplify refactors.
- Targets: `my-app/tsconfig.json`, all new hooks and lib files
- Effort: small | Risk: low

12) Optimize Images and Static Assets with Next
- Description: Replace raw `<img>` for app icons/images with `next/image` where appropriate to leverage optimization. Ensure public assets referenced from PWA manifest are correct and use static export-friendly locations.
- Targets: components using images, `public/manifest.json`
- Effort: small | Risk: low

13) Clean App Router Patterns & File Layout
- Description: Adopt a clear app-folder structure convention: server components in `app/(routes)/...`, client-only subfolders `client/` or `components/client/` for components that require browser APIs, and `app/api/` for route handlers. Document pattern in `docs/dev/REFRACTORING_GUIDE.md`.
- Targets: repo-wide layout changes and docs
- Effort: medium | Risk: low-medium

14) Review next.config & build pipeline for modern defaults
- Description: Consider enabling recommended Next.js optimizations (swcMinify, image config, compiler options), and ensure CI uses `next build`/`next lint` with a cache-friendly pipeline.
- Targets: `my-app/next.config.ts`, CI config (if added)
- Effort: small | Risk: low

Instructions: Use this `todo-next.txt` as the Next.js-specific companion to the broader `todo.txt`. I can now implement any of these items incrementally — tell me which task to start with and I'll create the scaffolding and code.