@layer tokens {
  :root {
    --nav-height: 3rem;
    --fab-size: 3.25rem;
    --sheet-max: 34rem;
    --sheet-backdrop: color-mix(in srgb, var(--text) 35%, transparent);
    --snackbar-bg: color-mix(in srgb, var(--surface) 85%, var(--bg));
  }
}

@layer layout {
  .app-shell {
    min-block-size: 100dvh;
  }

  .app-main {
    padding-block: var(--space-5) calc(var(--nav-height) + var(--space-7) + env(safe-area-inset-bottom));
    padding-inline: 0;
  }

  .page {
    display: grid;
    gap: var(--space-5);
  }

  .page__section {
    display: grid;
    gap: var(--space-4);
  }
}

@layer components {
  .btn {
    min-block-size: 48px;
  }
  body[data-sheet-open="true"] {
    overflow: hidden;
    touch-action: none;
  }

  .route-view[data-vt="false"][data-anim="enter"] {
    animation: page-in var(--dur-2) var(--ease-1);
  }

  @keyframes page-in {
    from { opacity: 0; transform: translateY(6px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .bottom-nav {
    position: fixed;
    inset-block-end: 0;
    inset-inline: 0;
    z-index: 10;
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-1);
    padding-block: var(--space-2) calc(var(--space-2) + env(safe-area-inset-bottom));
    padding-inline: var(--gutter);
    background: var(--surface);
    border-top: var(--border-1) solid var(--border-soft);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
  }

  @supports (backdrop-filter: blur(1px)) or (-webkit-backdrop-filter: blur(1px)) {
    .bottom-nav {
      background: color-mix(in srgb, var(--surface) 92%, transparent);
    }
  }

  .bottom-nav__item {
    min-block-size: 44px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 2px;
    border-radius: var(--r-2);
    font-size: 0.6875rem;
    font-weight: 500;
    color: var(--muted);
    transition: color var(--dur-2) var(--ease-1);
    position: relative;
  }

  .bottom-nav__item[aria-current="page"] {
    color: var(--brand);
  }

  .bottom-nav__item[aria-current="page"]::after {
    content: "";
    position: absolute;
    inset-inline: 50%;
    inset-block-end: 0;
    transform: translateX(-50%);
    inline-size: 20px;
    block-size: 3px;
    border-radius: var(--r-pill);
    background: var(--brand);
  }

  .bottom-nav__icon {
    inline-size: 22px;
    block-size: 22px;
    color: currentColor;
  }

  .bottom-nav__label {
    font-weight: 500;
  }

  .header-bar {
    position: sticky;
    inset-block-start: 0;
    z-index: 6;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-3);
    padding-block: var(--space-3);
    padding-inline: var(--gutter);
    margin-inline: calc(-1 * var(--gutter));
    background: color-mix(in srgb, var(--bg) 90%, transparent);
    border-bottom: var(--border-1) solid var(--border-soft);
    backdrop-filter: blur(10px);
  }

  .header-bar__title {
    font-size: var(--fs-4);
    line-height: var(--lh-tight);
  }

  .header-bar__subtitle {
    font-size: var(--fs-1);
  }

  .program-card {
    display: block;
    inline-size: 100%;
    text-align: left;
    cursor: pointer;
  }

  .program-card .card__body {
    padding: var(--space-4);
    gap: var(--space-3);
  }

  .program-card__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-3);
  }

  .program-card__note {
    font-size: var(--fs-1);
  }

  .exercise-card .card__body {
    padding: var(--space-4);
    gap: var(--space-3);
  }

  .exercise-card__sets {
    display: grid;
    gap: var(--space-2);
  }

  .exercise-card__header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: var(--space-3);
  }

  .exercise-card__add {
    justify-content: center;
    min-block-size: 48px;
  }

  .set-row {
    display: grid;
    grid-template-columns: 1fr auto auto;
    gap: var(--space-3);
    align-items: center;
    padding: var(--space-3);
    border-radius: var(--r-2);
    border: var(--border-1) solid var(--border-soft);
    background: var(--surface-2);
    min-block-size: 56px;
    cursor: pointer;
    transition: transform var(--dur-1) var(--ease-1), opacity var(--dur-1) var(--ease-1);
  }

  .set-row--highlight {
    box-shadow: 0 0 0 2px color-mix(in srgb, var(--brand) 35%, transparent);
    animation: set-highlight-fade var(--dur-2) var(--ease-1) forwards;
  }

  @keyframes set-highlight-fade {
    0% { opacity: 0.85; }
    100% { opacity: 1; }
  }

  .set-row__edit {
    background: transparent;
    border: none;
    padding: 0;
    display: grid;
    gap: 0.1rem;
    text-align: left;
    min-block-size: 48px;
  }

  .set-row__weight,
  .set-row__reps {
    display: grid;
    gap: 0.1rem;
  }

  .set-row__reps {
    text-align: right;
  }

  .set-row__reps-label {
    font-size: var(--fs-1);
  }

  .set-row__kg {
    font-size: var(--fs-3);
    font-weight: 600;
  }

  .set-row__lb,
  .set-row__plates {
    font-size: var(--fs-1);
  }

  .set-row__reps-value {
    font-size: var(--fs-3);
    font-weight: 600;
  }

  .set-row__meta {
    display: grid;
    gap: var(--space-2);
    justify-items: end;
    align-items: center;
  }

  .set-row--static {
    cursor: default;
    grid-template-columns: 1fr auto;
  }

  .set-row__menu {
    border: var(--border-1) solid transparent;
    background: transparent;
    color: var(--muted);
    min-inline-size: 36px;
    min-block-size: 36px;
    border-radius: var(--r-pill);
    display: grid;
    place-items: center;
    transition:
      transform var(--dur-1) var(--ease-1),
      background-color var(--dur-2) var(--ease-1),
      border-color var(--dur-2) var(--ease-1),
      color var(--dur-2) var(--ease-1);
  }

  .set-row__menu:hover {
    color: var(--danger);
    background: color-mix(in srgb, var(--danger) 12%, transparent);
    border-color: color-mix(in srgb, var(--danger) 35%, transparent);
  }

  .set-row__menu:active {
    transform: scale(0.96);
  }

  .set-row__menu svg {
    inline-size: 18px;
    block-size: 18px;
    transition: transform var(--dur-2) var(--ease-1);
  }

  @media (prefers-reduced-motion: no-preference) {
    .set-row__menu:hover svg {
      transform: rotate(-12deg) scale(1.05);
    }
  }

  .runner-header {
    position: sticky;
    inset-block-start: 0;
    z-index: 7;
    background: color-mix(in srgb, var(--bg) 92%, transparent);
    padding-block: var(--space-3);
    padding-inline: var(--gutter);
    margin-inline: calc(-1 * var(--gutter));
    backdrop-filter: blur(10px);
    border-bottom: var(--border-1) solid var(--border-soft);
  }

  .runner-header__title {
    font-size: var(--fs-3);
    font-weight: 600;
  }

  .runner-header__row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-3);
  }

  .sheet {
    position: fixed;
    inset: 0;
    z-index: 20;
    display: grid;
    align-items: end;
    justify-items: center;
  }

  .sheet[data-open="false"] {
    pointer-events: none;
  }

  .sheet__backdrop {
    position: absolute;
    inset: 0;
    background: var(--sheet-backdrop);
    border: none;
    padding: 0;
    opacity: 0;
    transition: opacity var(--dur-2) var(--ease-1);
  }

  .sheet__panel {
    inline-size: min(100%, var(--sheet-max));
    max-block-size: min(80dvh, 100%);
    margin-inline: auto;
    margin-block-end: env(safe-area-inset-bottom);
    border-radius: var(--r-3) var(--r-3) 0 0;
    transform: translateY(20%);
    opacity: 0;
    transition: transform var(--dur-3) var(--ease-2), opacity var(--dur-2) var(--ease-1);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .sheet[data-open="true"] .sheet__panel {
    transform: translateY(0);
    opacity: 1;
  }

  .sheet[data-open="true"] .sheet__backdrop {
    opacity: 1;
  }

  .sheet__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-3);
    padding: var(--space-4);
    border-bottom: var(--border-1) solid var(--border-soft);
  }

  .sheet__title {
    font-size: var(--fs-3);
  }

  .sheet__content {
    padding: var(--space-5);
    display: grid;
    gap: var(--space-4);
    flex: 1;
    min-block-size: 0;
    overflow: auto;
  }

  .sheet__footer {
    padding: var(--space-4);
    border-top: var(--border-1) solid var(--border-soft);
  }

  .sheet__actions {
    display: flex;
    justify-content: flex-end;
    gap: var(--space-3);
  }

  .sheet__list .list-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-3);
    padding: var(--space-3);
    border-radius: var(--r-2);
    border: var(--border-1) solid var(--border-soft);
    background: var(--surface-2);
  }

  .stepper {
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: var(--space-2);
    align-items: center;
  }

  .snackbar {
    position: fixed;
    inset-inline: var(--gutter);
    inset-block-end: calc(var(--nav-height) + var(--space-6) + env(safe-area-inset-bottom));
    z-index: 30;
    background: var(--snackbar-bg);
    border-radius: var(--r-2);
    border: var(--border-1) solid var(--border-soft);
    padding: var(--space-3) var(--space-4);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-3);
    box-shadow: var(--shadow-2);
    animation: snackbar-in var(--dur-2) var(--ease-1);
  }

  @keyframes snackbar-in {
    from { transform: translateY(12px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }


  .fab {
    position: fixed;
    inset-inline-end: var(--gutter);
    inset-block-end: calc(var(--nav-height) + var(--space-6) + env(safe-area-inset-bottom));
    inline-size: var(--fab-size);
    block-size: var(--fab-size);
    border-radius: 50%;
    display: grid;
    place-items: center;
    z-index: 12;
  }

  .resume-card {
    position: sticky;
    inset-block-start: calc(var(--space-3) + 2.75rem);
    z-index: 5;
  }

  .summary-page {
    padding-block-end: calc(var(--space-6) + env(safe-area-inset-bottom));
  }

  .summary-page__header {
    position: relative;
    padding-block-start: var(--space-2);
  }

  .summary-page__badge {
    inline-size: 48px;
    block-size: 48px;
    border-radius: 50%;
    background: color-mix(in srgb, var(--success) 14%, transparent);
    color: var(--success);
    display: grid;
    place-items: center;
    margin-block-end: var(--space-2);
  }

  .summary-page__badge svg {
    inline-size: 26px;
    block-size: 26px;
  }

  @media (prefers-reduced-motion: no-preference) {
    .summary-page__badge {
      animation: summary-badge-in var(--dur-3) var(--ease-1) both;
    }
  }

  @keyframes summary-badge-in {
    from { opacity: 0; transform: scale(0.85); }
    to { opacity: 1; transform: scale(1); }
  }

  .summary-page__sticky {
    position: sticky;
    inset-block-end: 0;
    padding-block-start: var(--space-6);
    padding-block-end: env(safe-area-inset-bottom);
    background: var(--bg);
  }

  .summary-page__done {
    inline-size: 100%;
  }

  .summary-stats {
    display: grid;
    gap: var(--space-3);
  }

  .summary-stat {
    padding: var(--space-4);
    border-radius: var(--r-2);
    border: var(--border-1) solid var(--border-soft);
    background: var(--surface-2);
  }

  .summary-stat__value {
    font-size: var(--fs-4);
    font-weight: 600;
  }

  @media (prefers-reduced-motion: no-preference) {
    .summary-stats {
      animation: stats-float var(--dur-3) var(--ease-1) both;
    }
  }

  @keyframes stats-float {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .btn--danger {
    --_bg: color-mix(in srgb, var(--danger) 18%, transparent);
    --_fg: var(--danger);
    --_bd: color-mix(in srgb, var(--danger) 35%, transparent);
  }

  .list-row {
    min-block-size: 52px;
  }

  .cluster--between {
    justify-content: space-between;
  }
}

@layer overrides {
  @media (prefers-reduced-motion: reduce) {
    .route-view[data-anim="enter"],
    .snackbar,
    .set-row--highlight,
    .summary-stats,
    .summary-page__badge,
    .sheet__panel,
    .sheet__backdrop {
      animation: none;
    }
  }
}

/* View Transition styles for motion themes (scoped via html[data-vt][data-motion]) */
@supports (view-transition-name: test) {
  @media (prefers-reduced-motion: no-preference) {
    html[data-vt="true"][data-motion="fade"]::view-transition-old(root),
    html[data-vt="true"][data-motion="fade"]::view-transition-new(root) {
      animation-duration: 280ms;
      animation-timing-function: cubic-bezier(0.2, 0.9, 0.2, 1);
      animation-fill-mode: both;
    }

    html[data-vt="true"][data-motion="fade"]::view-transition-old(root) {
      animation-name: vt-fade-old;
    }
    html[data-vt="true"][data-motion="fade"]::view-transition-new(root) {
      animation-name: vt-fade-new;
    }

    @keyframes vt-fade-old {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-6px); }
    }
    @keyframes vt-fade-new {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Push / iOS-style (directional) */
    html[data-vt="true"][data-motion="push"][data-nav="forward"]::view-transition-old(root) {
      animation-name: vt-push-old-forward;
      animation-duration: 320ms;
      animation-timing-function: cubic-bezier(0.2, 0.9, 0.2, 1);
    }
    html[data-vt="true"][data-motion="push"][data-nav="forward"]::view-transition-new(root) {
      animation-name: vt-push-new-forward;
      animation-duration: 320ms;
      animation-timing-function: cubic-bezier(0.2, 0.9, 0.2, 1);
    }

    html[data-vt="true"][data-motion="push"][data-nav="back"]::view-transition-old(root) {
      animation-name: vt-push-old-back;
      animation-duration: 320ms;
      animation-timing-function: cubic-bezier(0.2, 0.9, 0.2, 1);
    }
    html[data-vt="true"][data-motion="push"][data-nav="back"]::view-transition-new(root) {
      animation-name: vt-push-new-back;
      animation-duration: 320ms;
      animation-timing-function: cubic-bezier(0.2, 0.9, 0.2, 1);
    }

    @keyframes vt-push-old-forward { from { transform: translateX(0); } to { transform: translateX(-12%); opacity: 0.8; } }
    @keyframes vt-push-new-forward { from { transform: translateX(12%); opacity: 0.9; } to { transform: translateX(0); opacity: 1; } }
    @keyframes vt-push-old-back { from { transform: translateX(0); } to { transform: translateX(12%); opacity: 0.8; } }
    @keyframes vt-push-new-back { from { transform: translateX(-12%); opacity: 0.9; } to { transform: translateX(0); opacity: 1; } }

    /* Zoom / snappy */
    html[data-vt="true"][data-motion="zoom"]::view-transition-old(root) {
      animation-name: vt-zoom-old;
      animation-duration: 220ms;
      animation-timing-function: cubic-bezier(0.2, 0.9, 0.2, 1);
    }
    html[data-vt="true"][data-motion="zoom"]::view-transition-new(root) {
      animation-name: vt-zoom-new;
      animation-duration: 220ms;
      animation-timing-function: cubic-bezier(0.2, 0.9, 0.2, 1);
    }

    @keyframes vt-zoom-old { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.98); } }
    @keyframes vt-zoom-new { 0% { opacity: 0; transform: scale(0.98); } 60% { opacity: 1; transform: scale(1.02); } 100% { transform: scale(1); } }

    /* Hero variants: respect selected motion style */
    html[data-vt="true"][data-motion="fade"]::view-transition-old(vt-hero) { animation: vt-fade-old 280ms both; }
    html[data-vt="true"][data-motion="fade"]::view-transition-new(vt-hero) { animation: vt-fade-new 280ms both; }

    html[data-vt="true"][data-motion="push"][data-nav="forward"]::view-transition-old(vt-hero) { animation: vt-push-old-forward 320ms both; }
    html[data-vt="true"][data-motion="push"][data-nav="forward"]::view-transition-new(vt-hero) { animation: vt-push-new-forward 320ms both; }

    html[data-vt="true"][data-motion="push"][data-nav="back"]::view-transition-old(vt-hero) { animation: vt-push-old-back 320ms both; }
    html[data-vt="true"][data-motion="push"][data-nav="back"]::view-transition-new(vt-hero) { animation: vt-push-new-back 320ms both; }

    html[data-vt="true"][data-motion="zoom"]::view-transition-old(vt-hero) { animation: vt-zoom-old 220ms both; }
    html[data-vt="true"][data-motion="zoom"]::view-transition-new(vt-hero) { animation: vt-zoom-new 220ms both; }
  }

  /* Reduced motion: explicitly disable VT animations and hero effects */
  @media (prefers-reduced-motion: reduce) {
    html::view-transition-old(root),
    html::view-transition-new(root),
    html::view-transition-old(vt-hero),
    html::view-transition-new(vt-hero) {
      animation: none !important;
    }
  }
}
